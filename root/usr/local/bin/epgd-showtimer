#!/bin/bash
# /usr/local/bin/epgd-showtimer

# ----------------------------------------------------------------------------
# This script is licensed under the GNU General Public License, Version 2.0.
#
# Original Source: https://github.com/horchi/vdr-epg-daemon
# Modified by: Lapicidae (https://github.com/lapicidae)
# ----------------------------------------------------------------------------


# Set common config file path
common_conf="${common_conf_path:-"/usr/local/etc/epgd-common.sh"}"

if [ ! -r "$common_conf" ]; then
	echo "ERROR: Config file not found or readable: $common_conf" >&2
	exit 1
fi

# Exit on errors, use pipefail, and treat unset variables as an error
set -euo pipefail

# Source the configuration file
# shellcheck source=/dev/null
source "$common_conf"


if [ "$#" -eq 0 ]; then
	STATE="(t.state != 'D' or t.state is null)"
else
	STATE="t.state like '$1'"
fi

$DB_USER_COMMAND ' \
select from_unixtime(t.inssp, "%d.%m %H:%i") as ins, v.name, substr(t.source, 25) as source, t.id, t.autotimerid as aid, t.state as S, t.info, t.action as A, \
		t.eventid, concat(from_unixtime(day, "%d.%m "), concat_ws(":", right(concat("00", t.starttime DIV 100), 2), right(concat("00", t.starttime%100), 2))) as start, \
		concat_ws(":", right(concat("00", t.endtime DIV 100), 2), right(concat("00", t.endtime%100), 2)) as end, \
		e.title, e.shorttext, t.file  \
	from \
		timers t left outer join events e on (t.eventid = e.masterid), vdrs v  \
	where \
		v.uuid = t.vdruuid and '"$STATE"' \
	order by t.day, start;'


# vim: ts=4 sw=4 noet:
# kate: space-indent off; indent-width 4; mixed-indent off;
